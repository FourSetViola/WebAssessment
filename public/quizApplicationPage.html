<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="css/quizPage.css" />
    <title>Quiz Page</title>
  </head>
  <body>
    <script src="js/quizApplicationPage.js"></script>
    <header>
      <nav>
        <h1>Quiz Page</h1>
        <a class="links" href="/">Introduction Page</a>
        <a class="links" href="/aboutPage">About Page</a>
        </nav>
    </header>

    <section>
      <!-- The Start Menu of the Quiz -->
      <div class="page startMenu">
        <h2>Welcome to the Quiz Page!</h2>
        <p>For every question, you have 15 seconds to answer.<p>
        <p>Once you have clicked an option, your answer would be automatically submitted.
        If you failed to answer the question in the time limit. it is marked as a wrong answer.</p>
        <p>You would know whether your answer is correct or not once you've submitted.<br>
        The quiz consists of 10 questions on English Football. Hope you'd enjoy it.</p>
        <p>Please enter your name here:</p>
        <div class="nameInput">
          <input type="text" id="name" name="name" required>
          <input type="submit" class="nextButton" value="Start" onclick="startQuiz()">
        </div>
      </div>
      <!-- The Question Page -->
      <div class="page question">
        <h2></h2>
        <div class="options"></div>
        <div class="timer"></div>
      </div>
      <!-- The Result Page for Every Question Page -->
      <div class="page result">
        <h2 style="width: 100%; text-align: center;"></h2>
        <button class="nextButton" onclick="nextQuestion()"><p>Next Question</p></button>
      </div>
      <!-- The End of the Quiz-->
      <div class="page end">
        <h2>End of the Quiz</h2>
        <h2 id="score"></h2>
      </div>
    </section>

    <!-- <script src="/socket.io/socket.io.js"></script> Socket.io For Codio Server -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script> <!--Socket.io For My Local Machine, works poor on codio-->
    <script src="js/quizApplicationPage.js"></script>
    
    <script>
      const socket = io();
      var idx = 0;
      var timeLimit;

      function startQuiz() {
          var name = document.getElementById("name").value;
          if (name === "") {
            alert("Please enter your name!");
            return;
          }
          socket.emit("startQuiz", name);
          const startMenu = document.querySelector(".startMenu");
          startMenu.style.display = "none";
          renderQuestion(idx); 
      }

      function renderQuestion(idx) {
        // inform the server that we need a new question
        socket.emit("questionNeeded", idx);
        // execute when we received a new question from the server
        socket.on("questionSent", (question) => {
          // initialize the pages
          const result = document.querySelector(".result");
          result.style.display = "none";
          const questionPage = document.querySelector(".question");
          questionPage.style.display = "grid";
          const optionsBox = document.querySelector(".options");
          optionsBox.innerHTML = "";
          // render the question we received from the server
          const questionElement = document.querySelector(".question h2");
          questionElement.innerHTML = question.question;
          // create an optionElement for every option
          question.options.forEach((option) => {
            // creation of the option element
            const optionElement = document.createElement("div");
            optionElement.className = "option";
            optionElement.dataset.index = option.choice;
            optionElement.innerHTML = option.choice + ": " + option.answer;

            //  Define the click events for the options
            optionElement.addEventListener("click", () => {
              clearTimeout(timeLimit);
              socket.emit("answerSubmitted", {"idx": idx, "choice": option.choice});
              optionElement.style.backgroundColor = "lightblue";
              optionElement.style.color = "black";
              optionElement.style.pointerEvents = "none";
            });
            // Add the options to the options box
            optionsBox.appendChild(optionElement);
          });
        });
        // Trigger the timer animation
        const timer = document.querySelector(".timer");
        timer.classList.add("timer-animation");
        timeLimit = setTimeout(() => {
          showResult(false);
        }, 15000);
      }

      function showResult (verified) {
        // initialize the pages
        const question = document.querySelector(".question");
        question.style.display = "none";
        const result = document.querySelector(".result");
        result.style.display = "grid";
        const messageSpace = document.querySelector(".result h2");
        // Show corresponding messsage on the outcome of the question
        const message = verified ? `<h2>Correct! Way to go!<h2>` : `<h2>Oops, seems like a wrong answer.<h2>`;
        messageSpace.innerHTML = message;
      }

      // wait for the server to respone this answer
      socket.on("answerVerified", (result) => {
        if (result) {
          showResult(true);
          } else {
          showResult(false);    
          }
        });
      
      // when the button is clicked
      function nextQuestion() {
        // move on to next page, index out of bound case is handled at the server side,
        // the client does not need to know how many questions there are
        idx += 1;
        // wait for the ending signal of the quiz
        renderQuestion(idx);
        socket.on("quizEnded", (scoreMessage) => {
          clearTimeout(timeLimit);
          const result = document.querySelector(".result");
          result.style.display = "none";
          const end = document.querySelector(".end");
          end.style.display = "grid";
          const score = document.getElementById("score");
          score.innerHTML = `<h2>You got ${scoreMessage.count} out of ${scoreMessage.total} right!<h2>`;
        });
      }

      socket.on('leaderBoard', (leaders) => {
        console.log(leaders);
      });
    </script>
    </body>
</html>